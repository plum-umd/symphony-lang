principal A[2] -- Just integers
principal B[2] -- Both integers and queries

-- basic functions

def length :
    list â„¤{bgw:all}
  â†’ â„¤{bgw:all}
def length xs = case xs
  { [] â†’ 0
  ; xâˆ·xs â†’ 1 + length xs
  }

def elem :
    â„¤{bgw:all}
  â†’ list â„¤{bgw:all}
  â†’ ğ”¹{bgw:all}
def elem y xs = case xs
  { [] â†’ false
  ; xâˆ·xs â†’
    let b = x == y
    in b ? true â—‡ (elem y xs)
  }

def elem-at :
    â„¤{bgw:all}
  â†’ list â„¤{bgw:all}
  â†’ â„¤{bgw:all}
def elem-at i xs = case xs
  { [] â†’ -1
  ; xâˆ·xs â†’
    let b = i â‰¡ 0
    in b ? x â—‡ (elem-at (i-1) xs)
  }

def append :
    list â„¤{bgw:all}
  â†’ list â„¤{bgw:all}
  â†’ list â„¤{bgw:all}
def append xs ys = case xs
  { [] â†’ ys
  ; (xâˆ·xs) â†’ append xs (xâˆ·ys)
  }

def share-list :
    list â„¤{A}
  â†’ list â„¤{bgw:all}
def share-list xs = case xs
  { [] â†’ []
  ; xâˆ·xsâ€² â†’ (share{bgw:all} x) âˆ· (share-list xsâ€²)
  }

def combine-lists :
    list â„¤{isec:A,B}
  â†’ list â„¤{bgw:all}
def combine-lists xs =
  append (share-list xs.A_1) (append (share-list xs.A_2) (append (share-list xs.B_1) (share-list xs.B_2)))
  

-- query functions

def min :
    list â„¤{bgw:all}
  â†’ â„¤{bgw:all}
def min xs = case xs
  { [x] â†’ x
  ; xâˆ·xs â†’
    let y = min xs
    let b = x < y
    in b ? x â—‡ y
  }


def max :
    list â„¤{bgw:all}
  â†’ â„¤{bgw:all}
def max xs = case xs
  { [x] â†’ x
  ; xâˆ·xs â†’
    let y = max xs
    let b = x > y
    in b ? x â—‡ y
  }


def median :
    list â„¤{bgw:all}
  â†’ â„¤{bgw:all}
def median xs = 0 -- not implemented


def num-unique :
    list â„¤{bgw:all}
  â†’ â„¤{bgw:all}
def num-unique xs = num-unique-rec xs []

def num-unique-rec :
    list â„¤{bgw:all}
  â†’ list â„¤{bgw:all}
  â†’ â„¤{bgw:all}
def num-unique-rec xs seen = case xs
  { [] â†’ length seen
  ; xâˆ·xs â†’
    let b = elem x seen
    in b ? num-unique-rec xs seen â—‡ num-unique-rec xs (xâˆ·seen)
  }


-- atq

def run-queries :
    list â„¤{isec:A,B}
  â†’ list â„¤{bgw:all}
def run-queries xs =
  let xsâ€² = combine-lists xs
  in (min xsâ€²) âˆ· (max xsâ€²) âˆ· (median xsâ€²) âˆ· (num-unique xsâ€²)

def send-result :
    (t : â„™)
  â†’ list â„¤{bgw:all}
  â†’ â„¤{isec:B}
  â†’ â„¤{ssec:t}
def send-result t results q =
  reveal{t} (elem-at index results)

def send-results :
    list â„¤{bgw:all}
  â†’ list â„¤{isec:B}
  â†’ list â„™{isec:B}
  â†’ list â„¤{ssec:hmm}
def send-results results qs ts = case (qs,ts)
  { ([],[]) â†’ []
  ; (q:qs,t:ts) â†’ (send-result t results q) âˆ· send-results results qs ts
  }

def main : ğŸ™ â†’{inp:A,B;rev:hmmm} list â„¤{ssec:hmm}
def main â€¢ =
  let xs : list â„¤{isec:A,B}
  let xs = {par:A,B} read (list â„¤) "atq-data.txt"
  let qs : list â„¤{isec:B}
  let qs = {par:B} read (list â„¤) "atq-queries.txt"
  let ts : list â„™{isec:B}
  let ts = {par:B} read (list â„™) "atq-targets.txt"
  let results = run-queries xs
  in send-results results qs ts
