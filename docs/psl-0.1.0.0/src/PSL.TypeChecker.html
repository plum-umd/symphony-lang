<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">PSL.TypeChecker</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">UVMHS</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-keyword">import</span><span> </span><a href="PSL.Syntax.html"><span class="hs-identifier">PSL.Syntax</span></a><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-8"></a><span class="hs-comment">-- ENVIRONMENT --</span><span>
</span><a name="line-9"></a><span class="hs-comment">-----------------</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-comment">-- &#915; &#8712; ctmenv</span><span>
</span><a name="line-12"></a><span class="hs-keyword">type</span><span> </span><a name="CTyEnv"><a href="PSL.TypeChecker.html#CTyEnv"><span class="hs-identifier">CTyEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">TVar</span><span> </span><span class="hs-operator hs-type">&#8688;</span><span> </span><a href="PSL.Syntax.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">type</span><span> </span><a name="CTmDec"><a href="PSL.TypeChecker.html#CTmDec"><span class="hs-identifier">CTmDec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-operator hs-type">&#8688;</span><span> </span><a href="PSL.Syntax.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">type</span><span> </span><a name="CTmEnv"><a href="PSL.TypeChecker.html#CTmEnv"><span class="hs-identifier">CTmEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-operator hs-type">&#8688;</span><span> </span><a href="PSL.Syntax.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">type</span><span> </span><a name="CTLTmEnv"><a href="PSL.TypeChecker.html#CTLTmEnv"><span class="hs-identifier">CTLTmEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-operator hs-type">&#8688;</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-operator hs-type">&#8743;</span><span> </span><a href="PSL.Syntax.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">type</span><span> </span><a name="CTLDefns"><a href="PSL.TypeChecker.html#CTLDefns"><span class="hs-identifier">CTLDefns</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Var</span><span> </span><span class="hs-operator hs-type">&#8688;</span><span> </span><a href="PSL.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-comment">-----------</span><span>
</span><a name="line-19"></a><span class="hs-comment">-- STATE --</span><span>
</span><a name="line-20"></a><span class="hs-comment">-----------</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-comment">-- &#931; &#8712; ctlstate</span><span>
</span><a name="line-23"></a><span class="hs-keyword">data</span><span> </span><a name="CTLState"><a href="PSL.TypeChecker.html#CTLState"><span class="hs-identifier">CTLState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CTLState"><a href="PSL.TypeChecker.html#CTLState"><span class="hs-identifier">CTLState</span></a></a><span>
</span><a name="line-24"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="ctlStatePrins"><a href="PSL.TypeChecker.html#ctlStatePrins"><span class="hs-identifier">ctlStatePrins</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="hs-identifier hs-type">PrinExp</span><span> </span><span class="hs-operator hs-type">&#8688;</span><span> </span><a href="PSL.Syntax.html#PrinKind"><span class="hs-identifier hs-type">PrinKind</span></a><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ctlStateTyDec"><a href="PSL.TypeChecker.html#ctlStateTyDec"><span class="hs-identifier">ctlStateTyDec</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.TypeChecker.html#CTyEnv"><span class="hs-identifier hs-type">CTyEnv</span></a><span>
</span><a name="line-26"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ctlStateTyEnv"><a href="PSL.TypeChecker.html#ctlStateTyEnv"><span class="hs-identifier">ctlStateTyEnv</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.TypeChecker.html#CTyEnv"><span class="hs-identifier hs-type">CTyEnv</span></a><span>
</span><a name="line-27"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ctlStateTmDec"><a href="PSL.TypeChecker.html#ctlStateTmDec"><span class="hs-identifier">ctlStateTmDec</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.TypeChecker.html#CTmDec"><span class="hs-identifier hs-type">CTmDec</span></a><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ctlStateTmEnv"><a href="PSL.TypeChecker.html#ctlStateTmEnv"><span class="hs-identifier">ctlStateTmEnv</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.TypeChecker.html#CTLTmEnv"><span class="hs-identifier hs-type">CTLTmEnv</span></a><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="ctlStateDefns"><a href="PSL.TypeChecker.html#ctlStateDefns"><span class="hs-identifier">ctlStateDefns</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.TypeChecker.html#CTLDefns"><span class="hs-identifier hs-type">CTLDefns</span></a><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-identifier hs-var">makePrettySum</span><span> </span><span class="hs-special">''</span><span class="hs-identifier hs-var">CTLState</span><span>
</span><a name="line-32"></a><span class="hs-identifier hs-var">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier hs-var">CTLState</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-identifier">&#963;tl&#8320;</span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.TypeChecker.html#CTLState"><span class="hs-identifier hs-type">CTLState</span></a><span>
</span><a name="line-35"></a><a name="%3C3tl%2080"><a href="PSL.TypeChecker.html#%3C3tl%2080"><span class="hs-identifier">&#963;tl&#8320;</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="PSL.TypeChecker.html#CTLState"><span class="hs-identifier hs-var">CTLState</span></a><span> </span><span class="hs-identifier hs-var">d&#248;</span><span> </span><span class="hs-identifier hs-var">d&#248;</span><span> </span><span class="hs-identifier hs-var">d&#248;</span><span> </span><span class="hs-identifier hs-var">d&#248;</span><span> </span><span class="hs-identifier hs-var">d&#248;</span><span> </span><span class="hs-identifier hs-var">d&#248;</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-38"></a><span class="hs-comment">-- CONTEXT --</span><span>
</span><a name="line-39"></a><span class="hs-comment">-------------</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-comment">-- &#926; &#8712; ccxt</span><span>
</span><a name="line-42"></a><span class="hs-keyword">data</span><span> </span><a name="CCxt"><a href="PSL.TypeChecker.html#CCxt"><span class="hs-identifier">CCxt</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CCxt"><a href="PSL.TypeChecker.html#CCxt"><span class="hs-identifier">CCxt</span></a></a><span>
</span><a name="line-43"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="cCxtSource"><a href="PSL.TypeChecker.html#cCxtSource"><span class="hs-identifier">cCxtSource</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="hs-identifier hs-type">&#119874;</span><span> </span><span class="hs-identifier hs-type">FullContext</span><span>
</span><a name="line-44"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="cCxtPrins"><a href="PSL.TypeChecker.html#cCxtPrins"><span class="hs-identifier">cCxtPrins</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="hs-identifier hs-type">PrinExp</span><span> </span><span class="hs-operator hs-type">&#8688;</span><span> </span><a href="PSL.Syntax.html#PrinKind"><span class="hs-identifier hs-type">PrinKind</span></a><span>
</span><a name="line-45"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="cCxtTyDec"><a href="PSL.TypeChecker.html#cCxtTyDec"><span class="hs-identifier">cCxtTyDec</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.TypeChecker.html#CTyEnv"><span class="hs-identifier hs-type">CTyEnv</span></a><span>
</span><a name="line-46"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="cCxtTyEnv"><a href="PSL.TypeChecker.html#cCxtTyEnv"><span class="hs-identifier">cCxtTyEnv</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.TypeChecker.html#CTyEnv"><span class="hs-identifier hs-type">CTyEnv</span></a><span>
</span><a name="line-47"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="cCxtTmDec"><a href="PSL.TypeChecker.html#cCxtTmDec"><span class="hs-identifier">cCxtTmDec</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.TypeChecker.html#CTmDec"><span class="hs-identifier hs-type">CTmDec</span></a><span>
</span><a name="line-48"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="cCxtTmEnv"><a href="PSL.TypeChecker.html#cCxtTmEnv"><span class="hs-identifier">cCxtTmEnv</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.TypeChecker.html#CTmEnv"><span class="hs-identifier hs-type">CTmEnv</span></a><span>
</span><a name="line-49"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="cCxtMode"><a href="PSL.TypeChecker.html#cCxtMode"><span class="hs-identifier">cCxtMode</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.Syntax.html#Mode"><span class="hs-identifier hs-type">Mode</span></a><span>
</span><a name="line-50"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-51"></a><span class="hs-identifier hs-var">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier hs-var">CCxt</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-identifier">&#958;&#8320;</span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.TypeChecker.html#CCxt"><span class="hs-identifier hs-type">CCxt</span></a><span>
</span><a name="line-54"></a><a name="%3BE%2080"><a href="PSL.TypeChecker.html#%3BE%2080"><span class="hs-identifier">&#958;&#8320;</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="PSL.TypeChecker.html#CCxt"><span class="hs-identifier hs-var">CCxt</span></a><span> </span><span class="hs-identifier hs-var">None</span><span> </span><span class="hs-identifier hs-var">d&#248;</span><span> </span><span class="hs-identifier hs-var">d&#248;</span><span> </span><span class="hs-identifier hs-var">d&#248;</span><span> </span><span class="hs-identifier hs-var">d&#248;</span><span> </span><span class="hs-identifier hs-var">d&#248;</span><span> </span><a href="PSL.Syntax.html#TopM"><span class="hs-identifier hs-var">TopM</span></a><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span class="hs-comment">------------</span><span>
</span><a name="line-57"></a><span class="hs-comment">-- OUTPUT --</span><span>
</span><a name="line-58"></a><span class="hs-comment">------------</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">-- o &#8712; cout</span><span>
</span><a name="line-61"></a><span class="hs-keyword">data</span><span> </span><a name="COut"><a href="PSL.TypeChecker.html#COut"><span class="hs-identifier">COut</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="COut"><a href="PSL.TypeChecker.html#COut"><span class="hs-identifier">COut</span></a></a><span>
</span><a name="line-62"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="cOutEff"><a href="PSL.TypeChecker.html#cOutEff"><span class="hs-identifier">cOutEff</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.Syntax.html#Effect"><span class="hs-identifier hs-type">Effect</span></a><span>
</span><a name="line-63"></a><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span class="hs-identifier hs-var">makePrettySum</span><span> </span><span class="hs-special">''</span><span class="hs-identifier hs-var">COut</span><span>
</span><a name="line-65"></a><span class="hs-identifier hs-var">makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier hs-var">COut</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-comment">-- instance Null COut where null = COut null</span><span>
</span><a name="line-68"></a><span class="hs-comment">-- instance Append COut where</span><span>
</span><a name="line-69"></a><span class="hs-comment">--   COut &#951;&#8321; &#10746; COut &#951;&#8322; = COut $ &#951;&#8321; &#10746; &#951;&#8322;</span><span>
</span><a name="line-70"></a><span class="hs-comment">-- instance Monoid COut</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span class="hs-comment">-----------</span><span>
</span><a name="line-73"></a><span class="hs-comment">-- ERROR --</span><span>
</span><a name="line-74"></a><span class="hs-comment">-----------</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span class="hs-keyword">data</span><span> </span><a name="CErrorClass"><a href="PSL.TypeChecker.html#CErrorClass"><span class="hs-identifier">CErrorClass</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-77"></a><span>    </span><a name="SyntaxCError"><a href="PSL.TypeChecker.html#SyntaxCError"><span class="hs-identifier">SyntaxCError</span></a></a><span>
</span><a name="line-78"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="TypeCError"><a href="PSL.TypeChecker.html#TypeCError"><span class="hs-identifier">TypeCError</span></a></a><span>
</span><a name="line-79"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NotImplementedCError"><a href="PSL.TypeChecker.html#NotImplementedCError"><span class="hs-identifier">NotImplementedCError</span></a></a><span>
</span><a name="line-80"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="InternalCError"><a href="PSL.TypeChecker.html#InternalCError"><span class="hs-identifier">InternalCError</span></a></a><span>
</span><a name="line-81"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span class="hs-identifier hs-var">makePrettySum</span><span> </span><span class="hs-special">''</span><span class="hs-identifier hs-var">CErrorClass</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span class="hs-comment">-- r &#8712; cerr</span><span>
</span><a name="line-85"></a><span class="hs-keyword">data</span><span> </span><a name="CError"><a href="PSL.TypeChecker.html#CError"><span class="hs-identifier">CError</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CError"><a href="PSL.TypeChecker.html#CError"><span class="hs-identifier">CError</span></a></a><span>
</span><a name="line-86"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="cErrorSource"><a href="PSL.TypeChecker.html#cErrorSource"><span class="hs-identifier">cErrorSource</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="hs-identifier hs-type">&#119874;</span><span> </span><span class="hs-identifier hs-type">FullContext</span><span>
</span><a name="line-87"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="cErrorCallStack"><a href="PSL.TypeChecker.html#cErrorCallStack"><span class="hs-identifier">cErrorCallStack</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="hs-identifier hs-type">CallStack</span><span>
</span><a name="line-88"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="cErrorClass"><a href="PSL.TypeChecker.html#cErrorClass"><span class="hs-identifier">cErrorClass</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.TypeChecker.html#CErrorClass"><span class="hs-identifier hs-type">CErrorClass</span></a><span>
</span><a name="line-89"></a><span>  </span><span class="hs-special">,</span><span> </span><a name="cErrorMsg"><a href="PSL.TypeChecker.html#cErrorMsg"><span class="hs-identifier">cErrorMsg</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="hs-identifier hs-type">Doc</span><span>
</span><a name="line-90"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-identifier">throwCErrorCxt</span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679539432"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">MonadReader</span><span> </span><a href="PSL.TypeChecker.html#CCxt"><span class="hs-identifier hs-type">CCxt</span></a><span> </span><a href="#local-6989586621679539432"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">MonadError</span><span> </span><a href="PSL.TypeChecker.html#CError"><span class="hs-identifier hs-type">CError</span></a><span> </span><a href="#local-6989586621679539432"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">STACK</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&#8658;</span><span> </span><a href="PSL.TypeChecker.html#CErrorClass"><span class="hs-identifier hs-type">CErrorClass</span></a><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-identifier hs-type">&#120138;</span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-identifier hs-type">&#119871;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">&#120138;</span><span> </span><span class="hs-operator hs-type">&#8743;</span><span> </span><span class="hs-identifier hs-type">Doc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><a href="#local-6989586621679539432"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679539433"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-93"></a><a name="throwCErrorCxt"><a href="PSL.TypeChecker.html#throwCErrorCxt"><span class="hs-identifier">throwCErrorCxt</span></a></a><span> </span><a name="local-6989586621679539434"><a href="#local-6989586621679539434"><span class="hs-identifier">ec</span></a></a><span> </span><a name="local-6989586621679539435"><a href="#local-6989586621679539435"><span class="hs-identifier">em</span></a></a><span> </span><a name="local-6989586621679539436"><a href="#local-6989586621679539436"><span class="hs-identifier">vals</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withFrozenCallStack</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-94"></a><span>  </span><a name="local-6989586621679539437"><a href="#local-6989586621679539437"><span class="hs-identifier">es</span></a></a><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="hs-identifier hs-var">askL</span><span> </span><a href="PSL.TypeChecker.html#cCxtSourceL"><span class="hs-identifier hs-var">cCxtSourceL</span></a><span>
</span><a name="line-95"></a><span>  </span><a href="PSL.TypeChecker.html#throwCError"><span class="hs-identifier hs-var">throwCError</span></a><span> </span><a href="#local-6989586621679539437"><span class="hs-identifier hs-var">es</span></a><span> </span><a href="#local-6989586621679539434"><span class="hs-identifier hs-var">ec</span></a><span> </span><a href="#local-6989586621679539435"><span class="hs-identifier hs-var">em</span></a><span> </span><a href="#local-6989586621679539436"><span class="hs-identifier hs-var">vals</span></a><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span class="hs-identifier">throwCError</span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679539430"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">MonadError</span><span> </span><a href="PSL.TypeChecker.html#CError"><span class="hs-identifier hs-type">CError</span></a><span> </span><a href="#local-6989586621679539430"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">STACK</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&#8658;</span><span> </span><span class="hs-identifier hs-type">&#119874;</span><span> </span><span class="hs-identifier hs-type">FullContext</span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><a href="PSL.TypeChecker.html#CErrorClass"><span class="hs-identifier hs-type">CErrorClass</span></a><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-identifier hs-type">&#120138;</span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-identifier hs-type">&#119871;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">&#120138;</span><span> </span><span class="hs-operator hs-type">&#8743;</span><span> </span><span class="hs-identifier hs-type">Doc</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><a href="#local-6989586621679539430"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679539431"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-98"></a><a name="throwCError"><a href="PSL.TypeChecker.html#throwCError"><span class="hs-identifier">throwCError</span></a></a><span> </span><a name="local-6989586621679539438"><a href="#local-6989586621679539438"><span class="hs-identifier">es</span></a></a><span> </span><a name="local-6989586621679539439"><a href="#local-6989586621679539439"><span class="hs-identifier">ec</span></a></a><span> </span><a name="local-6989586621679539440"><a href="#local-6989586621679539440"><span class="hs-identifier">em</span></a></a><span> </span><a name="local-6989586621679539441"><a href="#local-6989586621679539441"><span class="hs-identifier">vals</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-99"></a><span>  </span><span class="hs-identifier hs-var">throw</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="PSL.TypeChecker.html#CError"><span class="hs-identifier hs-var">CError</span></a><span> </span><a href="#local-6989586621679539438"><span class="hs-identifier hs-var">es</span></a><span> </span><span class="hs-identifier hs-var">callStack</span><span> </span><a href="#local-6989586621679539439"><span class="hs-identifier hs-var">ec</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppVertical</span><span>
</span><a name="line-100"></a><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">ppString</span><span> </span><a href="#local-6989586621679539440"><span class="hs-identifier hs-var">em</span></a><span>
</span><a name="line-101"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ppVertical</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapOn</span><span> </span><a href="#local-6989586621679539441"><span class="hs-identifier hs-var">vals</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679539442"><a href="#local-6989586621679539442"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><a name="local-6989586621679539443"><a href="#local-6989586621679539443"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-identifier hs-var">ppHorizontal</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">ppString</span><span> </span><a href="#local-6989586621679539442"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span class="hs-identifier hs-var">ppString</span><span> </span><span class="hs-string">&quot;=&quot;</span><span class="hs-special">,</span><a href="#local-6989586621679539443"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">]</span><span>
</span><a name="line-102"></a><span>    </span><span class="hs-special">]</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-105"></a><span class="hs-comment">-- TL MONAD --</span><span>
</span><a name="line-106"></a><span class="hs-comment">--------------</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-keyword">newtype</span><span> </span><a name="CTLM"><a href="PSL.TypeChecker.html#CTLM"><span class="hs-identifier">CTLM</span></a></a><span> </span><a name="local-6989586621679539429"><a href="#local-6989586621679539429"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CTLM"><a href="PSL.TypeChecker.html#CTLM"><span class="hs-identifier">CTLM</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="unCTLM"><a href="PSL.TypeChecker.html#unCTLM"><span class="hs-identifier">unCTLM</span></a></a><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="hs-identifier hs-type">RWST</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="PSL.TypeChecker.html#CTLState"><span class="hs-identifier hs-type">CTLState</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ErrorT</span><span> </span><a href="PSL.TypeChecker.html#CError"><span class="hs-identifier hs-type">CError</span></a><span> </span><span class="hs-identifier hs-type">ID</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679539429"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-109"></a><span>  </span><span class="hs-keyword">deriving</span><span>
</span><a name="line-110"></a><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Functor</span><span>
</span><a name="line-111"></a><span>  </span><span class="hs-special">,</span><span class="hs-identifier hs-type">Return</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Bind</span><span class="hs-special">,</span><span class="hs-identifier hs-type">Monad</span><span>
</span><a name="line-112"></a><span>  </span><span class="hs-special">,</span><span class="hs-identifier hs-type">MonadReader</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>  </span><span class="hs-special">,</span><span class="hs-identifier hs-type">MonadWriter</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>  </span><span class="hs-special">,</span><span class="hs-identifier hs-type">MonadState</span><span> </span><a href="PSL.TypeChecker.html#CTLState"><span class="hs-identifier hs-type">CTLState</span></a><span>
</span><a name="line-115"></a><span>  </span><span class="hs-special">,</span><span class="hs-identifier hs-type">MonadError</span><span> </span><a href="PSL.TypeChecker.html#CError"><span class="hs-identifier hs-type">CError</span></a><span>
</span><a name="line-116"></a><span>  </span><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span class="hs-identifier hs-var">makePrettySum</span><span> </span><span class="hs-special">''</span><span class="hs-identifier hs-var">CTLM</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-identifier">mkCTLM</span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="hs-special">(</span><a href="PSL.TypeChecker.html#CTLState"><span class="hs-identifier hs-type">CTLState</span></a><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-identifier hs-type">CError</span><span> </span><span class="hs-operator hs-type">&#8744;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CTLState</span><span> </span><span class="hs-operator hs-type">&#8743;</span><span> </span><a href="#local-6989586621679540295"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><a href="PSL.TypeChecker.html#CTLM"><span class="hs-identifier hs-type">CTLM</span></a><span> </span><a href="#local-6989586621679540295"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-120"></a><a name="mkCTLM"><a href="PSL.TypeChecker.html#mkCTLM"><span class="hs-identifier">mkCTLM</span></a></a><span> </span><a name="local-6989586621679540296"><a href="#local-6989586621679540296"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="PSL.TypeChecker.html#CTLM"><span class="hs-identifier hs-var">CTLM</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mkRWST</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679540297"><a href="#local-6989586621679540297"><span class="hs-identifier">&#963;</span></a></a><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-identifier hs-var">ErrorT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ID</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679540296"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679540297"><span class="hs-identifier hs-var">&#963;</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-121"></a><span>  </span><span class="hs-identifier hs-var">Inl</span><span> </span><a name="local-6989586621679540298"><a href="#local-6989586621679540298"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-identifier hs-var">Inl</span><span> </span><a href="#local-6989586621679540298"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-122"></a><span>  </span><span class="hs-identifier hs-var">Inr</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679540299"><a href="#local-6989586621679540299"><span class="hs-identifier">&#963;'</span></a></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><a name="local-6989586621679540300"><a href="#local-6989586621679540300"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-identifier hs-var">Inr</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679540299"><span class="hs-identifier hs-var">&#963;'</span></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">:*</span><span> </span><a href="#local-6989586621679540300"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-identifier">runCTLM</span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.TypeChecker.html#CTLState"><span class="hs-identifier hs-type">CTLState</span></a><span> </span><span class="hs-glyph">&#8594;</span><span> </span><a href="PSL.TypeChecker.html#CTLM"><span class="hs-identifier hs-type">CTLM</span></a><span> </span><a href="#local-6989586621679540294"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-identifier hs-type">CError</span><span> </span><span class="hs-operator hs-type">&#8744;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">CTLState</span><span> </span><span class="hs-operator hs-type">&#8743;</span><span> </span><a href="#local-6989586621679540294"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-125"></a><a name="runCTLM"><a href="PSL.TypeChecker.html#runCTLM"><span class="hs-identifier">runCTLM</span></a></a><span> </span><a name="local-6989586621679540301"><a href="#local-6989586621679540301"><span class="hs-identifier">&#963;</span></a></a><span> </span><a name="local-6989586621679540302"><a href="#local-6989586621679540302"><span class="hs-identifier">xM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">unID</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">unErrorT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">runRWST</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679540301"><span class="hs-identifier hs-var">&#963;</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">unCTLM</span><span> </span><a href="#local-6989586621679540302"><span class="hs-identifier hs-var">xM</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-126"></a><span>  </span><span class="hs-identifier hs-var">Inl</span><span> </span><a name="local-6989586621679540303"><a href="#local-6989586621679540303"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-identifier hs-var">Inl</span><span> </span><a href="#local-6989586621679540303"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-127"></a><span>  </span><span class="hs-identifier hs-var">Inr</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679540304"><a href="#local-6989586621679540304"><span class="hs-identifier">&#963;'</span></a></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">:*</span><span> </span><a name="local-6989586621679540305"><a href="#local-6989586621679540305"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-identifier hs-var">Inr</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679540304"><span class="hs-identifier hs-var">&#963;'</span></a><span> </span><span class="hs-operator hs-var">:*</span><span> </span><a href="#local-6989586621679540305"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-128"></a><span>
</span><a name="line-129"></a><span class="hs-identifier">evalCTLM</span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.TypeChecker.html#CTLState"><span class="hs-identifier hs-type">CTLState</span></a><span> </span><span class="hs-glyph">&#8594;</span><span> </span><a href="PSL.TypeChecker.html#CTLM"><span class="hs-identifier hs-type">CTLM</span></a><span> </span><a href="#local-6989586621679540293"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-identifier hs-type">CError</span><span> </span><span class="hs-operator hs-type">&#8744;</span><span> </span><a href="#local-6989586621679540293"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-130"></a><a name="evalCTLM"><a href="PSL.TypeChecker.html#evalCTLM"><span class="hs-identifier">evalCTLM</span></a></a><span> </span><a name="local-6989586621679540306"><a href="#local-6989586621679540306"><span class="hs-identifier">&#963;</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">&#8728;</span><span> </span><a href="PSL.TypeChecker.html#runCTLM"><span class="hs-identifier hs-var">runCTLM</span></a><span> </span><a href="#local-6989586621679540306"><span class="hs-identifier hs-var">&#963;</span></a><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-identifier">evalCTLMIO</span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><a href="PSL.TypeChecker.html#CTLState"><span class="hs-identifier hs-type">CTLState</span></a><span> </span><span class="hs-glyph">&#8594;</span><span> </span><a href="PSL.TypeChecker.html#CTLM"><span class="hs-identifier hs-type">CTLM</span></a><span> </span><a href="#local-6989586621679540292"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679540292"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-133"></a><a name="evalCTLMIO"><a href="PSL.TypeChecker.html#evalCTLMIO"><span class="hs-identifier">evalCTLMIO</span></a></a><span> </span><a name="local-6989586621679540307"><a href="#local-6989586621679540307"><span class="hs-identifier">&#963;</span></a></a><span> </span><a name="local-6989586621679540308"><a href="#local-6989586621679540308"><span class="hs-identifier">xM</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="PSL.TypeChecker.html#evalCTLM"><span class="hs-identifier hs-var">evalCTLM</span></a><span> </span><a href="#local-6989586621679540307"><span class="hs-identifier hs-var">&#963;</span></a><span> </span><a href="#local-6989586621679540308"><span class="hs-identifier hs-var">xM</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-134"></a><span>  </span><span class="hs-identifier hs-var">Inl</span><span> </span><span class="hs-special">(</span><a href="PSL.TypeChecker.html#CError"><span class="hs-identifier hs-var">CError</span></a><span> </span><a name="local-6989586621679540309"><a href="#local-6989586621679540309"><span class="hs-identifier">rsO</span></a></a><span> </span><a name="local-6989586621679540310"><a href="#local-6989586621679540310"><span class="hs-identifier">cs</span></a></a><span> </span><a name="local-6989586621679540311"><a href="#local-6989586621679540311"><span class="hs-identifier">rc</span></a></a><span> </span><a name="local-6989586621679540312"><a href="#local-6989586621679540312"><span class="hs-identifier">rm</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-135"></a><span>    </span><span class="hs-identifier hs-var">pprint</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppVertical</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concat</span><span>
</span><a name="line-136"></a><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">single&#119868;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">ppHeader</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show&#120138;</span><span> </span><a href="#local-6989586621679540311"><span class="hs-identifier hs-var">rc</span></a><span>
</span><a name="line-137"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">elim&#119874;</span><span> </span><span class="hs-identifier hs-var">empty&#119868;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">single&#119868;</span><span> </span><span class="hs-operator hs-var">&#8728;</span><span> </span><span class="hs-identifier hs-var">pretty</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679540309"><span class="hs-identifier hs-var">rsO</span></a><span>
</span><a name="line-138"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">single&#119868;</span><span> </span><a href="#local-6989586621679540312"><span class="hs-identifier hs-var">rm</span></a><span>
</span><a name="line-139"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">single&#119868;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">pretty</span><span> </span><a href="#local-6989586621679540310"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-140"></a><span>      </span><span class="hs-special">]</span><span>
</span><a name="line-141"></a><span>    </span><span class="hs-identifier hs-var">abortIO</span><span>
</span><a name="line-142"></a><span>  </span><span class="hs-identifier hs-var">Inr</span><span> </span><a name="local-6989586621679540313"><a href="#local-6989586621679540313"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679540313"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-comment">{-

-----------
-- MONAD --
-----------

newtype CM a = CM { unCM &#8759; RWST CCxt COut () (ErrorT CError ID) a }
  deriving
  (Functor
  ,Return,Bind,Monad
  ,MonadReader CCxt
  ,MonadWriter COut
  ,MonadState ()
  ,MonadError CError
  )
makePrettySum ''CM

mkCM &#8759; (CCxt &#8594; CError &#8744; (COut &#8743; a)) &#8594; CM a
mkCM f = CM $ mkRWST $ \ &#947; () &#8594; ErrorT $ ID $ case f &#947; of
  Inl r &#8594; Inl r
  Inr (o :* x) &#8594; Inr (() :* o :* x)

runCM &#8759; CCxt &#8594; CM a &#8594; CError &#8744; (COut &#8743; a)
runCM &#947; xM = case unID $ unErrorT $ runRWST &#947; () $ unCM xM of
  Inl r &#8594; Inl r
  Inr (() :* o :* x) &#8594; Inr (o :* x)

asCTLM &#8759; CM a &#8594; CTLM (COut &#8743; a)
asCTLM xM = mkCTLM $ \ &#963; &#8594; 
  let &#958; = &#958;&#8320; { cCxtPrins = ctlStatePrins &#963;
             , cCxtTyDec = ctlStateTyDec &#963;
             , cCxtTyEnv = ctlStateTyEnv &#963;
             , cCxtTmDec = ctlStateTmDec &#963;
             , cCxtTmEnv = map snd $ ctlStateTmEnv &#963;
             }
  in case runCM &#958; xM of
    Inl r &#8594; Inl r 
    Inr (o :* x) &#8594; Inr $ &#963; :* (o :* x)

-- =========== --
-- TYPECHECKER --
-- =========== --

----------------
-- PRIMITIVES --
----------------

primInferRaw &#8759; &#120138; &#8594; &#119871; Type &#8594; CM Type
primInferRaw o &#964;s = case (o,tohs &#964;s) of
  (&quot;LT&quot;,[&#8484;T n&#8321;,&#8484;T n&#8322;]) | n&#8321; &#8801; n&#8322; &#8594; return &#120121;T
  (&quot;LT&quot;,[&#8469;T n&#8321;,&#8469;T n&#8322;]) | n&#8321; &#8801; n&#8322; &#8594; return &#120121;T
  (&quot;GT&quot;,[&#8484;T n&#8321;,&#8484;T n&#8322;]) | n&#8321; &#8801; n&#8322; &#8594; return &#120121;T
  (&quot;GT&quot;,[&#8469;T n&#8321;,&#8469;T n&#8322;]) | n&#8321; &#8801; n&#8322; &#8594; return &#120121;T
  (&quot;LTE&quot;,[&#8484;T n&#8321;,&#8484;T n&#8322;]) | n&#8321; &#8801; n&#8322; &#8594; return &#120121;T
  (&quot;LTE&quot;,[&#8469;T n&#8321;,&#8469;T n&#8322;]) | n&#8321; &#8801; n&#8322; &#8594; return &#120121;T
  (&quot;GTE&quot;,[&#8484;T n&#8321;,&#8484;T n&#8322;]) | n&#8321; &#8801; n&#8322; &#8594; return &#120121;T
  (&quot;GTE&quot;,[&#8469;T n&#8321;,&#8469;T n&#8322;]) | n&#8321; &#8801; n&#8322; &#8594; return &#120121;T
  (&quot;EQ&quot;,[&#8484;T n&#8321;,&#8484;T n&#8322;]) | n&#8321; &#8801; n&#8322; &#8594; return &#120121;T
  (&quot;EQ&quot;,[&#8469;T n&#8321;,&#8469;T n&#8322;]) | n&#8321; &#8801; n&#8322; &#8594; return &#120121;T
  (&quot;MINUS&quot;,[&#8469;T n&#8321;,&#8469;T n&#8322;]) | n&#8321; &#8801; n&#8322; &#8594; return $ &#8469;T n&#8321;
  (&quot;MINUS&quot;,[&#8484;T n&#8321;,&#8484;T n&#8322;]) | n&#8321; &#8801; n&#8322; &#8594; return $ &#8484;T n&#8321;
  (&quot;MOD&quot;,[&#8469;T n&#8321;,&#8469;T n&#8322;]) | n&#8321; &#8801; n&#8322; &#8594; return $ &#8469;T n&#8321;
  (&quot;MOD&quot;,[&#8484;T n&#8321;,&#8484;T n&#8322;]) | n&#8321; &#8801; n&#8322; &#8594; return $ &#8484;T n&#8321;
  (&quot;COND&quot;,[&#120121;T,&#964;&#8321;,&#964;&#8322;]) | &#964;&#8321; &#8801; &#964;&#8322; &#8594; return $ &#964;&#8321;
  _ &#8594; throwCErrorCxt NotImplementedCError &quot;primInferRaw&quot; $ frhs
    [ (&quot;o&quot;,pretty o)
    , (&quot;&#964;s&quot;,pretty &#964;s)
    ]

primInferShare &#8759; &#120138; &#8594; &#119871; Type &#8594; Prot &#8594; &#119875; PrinExp &#8594; &#119868; Type &#8594; CM Type
primInferShare o &#964;s &#966; &#961;s &#964;sA = case &#964;s of
  Nil &#8594; do
    &#964; &#8592; primInferRaw o $ list &#964;sA
    return $ ShareT &#966; (list &#961;s) &#964;
  ShareT &#966;' &#961;s' &#964;' :&amp; &#964;s' | (&#966;' &#8801; &#966;) &#10835; (list &#961;s &#8801; &#961;s') &#8594; primInferShare o &#964;s' &#966; &#961;s $ &#964;sA &#10746; single &#964;'
  _ &#8594; throwCErrorCxt TypeCError &quot;primInferShare: &#964;s &#8713; {Nil,ShareT _ _ :&amp; _ | &#966;' &#8801; &#966; &#8743; &#961;s' &#8801; &#961;s}&quot; $ frhs
    [ (&quot;&#964;s&quot;,pretty &#964;s)
    ]

primInfer &#8759; &#120138; &#8594; &#119871; Type &#8594; CM Type
primInfer o &#964;s = case &#964;s of
  ShareT &#966; &#961;s _ :&amp; _ &#8594; primInferShare o &#964;s &#966; (pow &#961;s) null
  _ &#8594; primInferRaw o &#964;s

---------------
-- VARIABLES --
---------------

bindVar &#8759; Var &#8594; Type &#8594; CM a &#8594; CM a
bindVar x &#964; = mapEnvL cCxtTmEnvL ((x &#8614; &#964;) &#10828;)

---------------
-- PATTERNS  --
---------------

bindPat &#8759; Pat &#8594; Type &#8594; CM a &#8594; CM a
bindPat &#968; &#964; = case &#968; of
  BulP &#8594; id
  VarP x &#8594; bindVar x &#964;
  _ &#8594; const $ throwCErrorCxt NotImplementedCError &quot;bindPat&quot; $ frhs
    [ (&quot;&#968;&quot;,pretty &#968;)
    , (&quot;&#964;&quot;,pretty &#964;)
    ]

--------------------
-- TYPE INFERENCE --
--------------------

elabExpInfer &#8759; Exp &#8594; CM (Exp &#8743; Type)
elabExpInfer e = mapFst (siphon e) ^$ localL cCxtSourceL (Some $ annotatedTag e) $ case extract e of
  VarE x &#8594; do
    &#947; &#8592; askL cCxtTmEnvL
    case &#947; &#8917;? x of
      Some &#964; &#8594; return $ VarE x :* &#964;
      None &#8594; throwCErrorCxt SyntaxCError &quot;elabExpInfer: VarE: x &#8713; &#947;&quot; $ frhs
        [ (&quot;x&quot;,pretty x)
        , (&quot;&#947;&quot;,pretty &#947;)
        ]
  BoolE b &#8594; return $ BoolE b :* &#120121;T
  StrE s &#8594; return $ StrE s :* &#120138;T
  NatE pr n &#8594; return $ NatE pr n :* &#8469;T pr
  IntE pr i &#8594; return $ IntE pr i :* &#8484;T pr
  FltE pr d &#8594; return $ FltE pr d :* &#120125;T pr
  BulE &#8594; return $ BulE :* UnitT
  IfE e&#8321; e&#8322; e&#8323; &#8594; do
    e&#7473;&#8321; &#8592; elabExpCheck &#120121;T e&#8321;
    e&#7473;&#8322; :* &#964;&#8322; &#8592; elabExpInfer e&#8322;
    e&#7473;&#8323; :* &#964;&#8323; &#8592; elabExpInfer e&#8323;
    when (not $ &#964;&#8322; &#8801; &#964;&#8323;) $ \ _ &#8594;
      throwCErrorCxt TypeCError &quot;elabExpInfer: IfE: &#964;&#8322; &#8800; &#964;&#8322;&quot; $ frhs
        [ (&quot;&#964;&#8322;&quot;,pretty &#964;&#8322;)
        , (&quot;&#964;&#8323;&quot;,pretty &#964;&#8323;)
        ]
    return $ IfE e&#7473;&#8321; e&#7473;&#8322; e&#7473;&#8323; :* &#964;&#8322;
  -- LE Exp
  -- RE Exp
  -- TupE Exp Exp
  -- NilE
  -- ConsE Exp Exp
  -- LetTyE Var Type Exp
  -- LetE Pat Exp Exp
  -- CaseE Exp (&#119871; (Pat &#8743; Exp))
  -- LamE (&#119874; Var) Pat Exp
  -- AppE Exp Exp
  -- TLamE TVar Exp
  -- TAppE Exp Type
  -- SoloE PrinExp Exp
  -- ParE (&#119871; PrinExp) Exp
  -- ShareE Prot (&#119871; PrinExp) Exp
  -- AccessE Exp PrinExp
  -- BundleE (&#119871; (PrinExp &#8743; Exp))
  -- BundleUnionE Exp Exp
  -- RevealE (&#119871; PrinExp) Exp
  -- AscrE Exp Type
  -- ReadE Type Exp
  -- InferE
  -- HoleE
  -- PrimE &#120138; (&#119871; Exp)
  -- TraceE Exp Exp
  ShareE &#966; &#961;s&#8321; &#961;s&#8322; e' &#8594; do
    e&#7473;' :* &#964;' &#8592; elabExpInfer e'
    &#964;'' &#8592; case &#964;' of
          SecT _ &#964;'&#179; &#8594; return &#964;'&#179;
          &#120121;T &#8594; return &#120121;T
          &#8469;T n &#8594; return $ &#8469;T n
          &#8484;T n &#8594; return $ &#8484;T n
          _ &#8594; throwCErrorCxt TypeCError &quot;elabExpInfer: ShareE: &#964;' &#8713; {SecT _ _,&#120121;T,&#8469;T _,&#8484;T _}&quot; $ frhs 
            [ (&quot;&#964;'&quot;,pretty &#964;')
            ]
    return $ ShareE &#966; &#961;s&#8321; &#961;s&#8322; e&#7473;' :* ShareT &#966; &#961;s&#8322; &#964;''
  AccessE e' &#961; &#8594; do
    e&#7473;' :* &#964;' &#8592; elabExpInfer e'
    &#964;'' &#8592; case &#964;' of
      ISecT &#961;s &#964;'&#179; &#8594;
        if &#961; &#8712; pow &#961;s 
        then return $ SecT &#961; &#964;'&#179;
        else throwCErrorCxt TypeCError &quot;elabExpInfer: AccessE: ISecT: &#961; &#8713; &#961;s&quot; $ frhs
          [ (&quot;&#961;&quot;,pretty &#961;)
          , (&quot;&#961;s&quot;,pretty &#961;s)
          ]
      _ &#8594; throwCErrorCxt TypeCError &quot;elabExpInfer: AccessE: &#964;' &#8800; ISecT _ _&quot; $ frhs
        [ (&quot;&#964;'&quot;,pretty &#964;')
        ]
    return $ AccessE e&#7473;' &#961; :* &#964;''
  PrimE o es' &#8594; do
    e&#964;s&#7473;' &#8592; mapM elabExpInfer es'
    &#964;' &#8592; primInfer o $ map snd e&#964;s&#7473;'
    return $ PrimE o (map fst e&#964;s&#7473;') :* &#964;'
  ParE &#961;s e' &#8594; do
    e&#7473;' :* &#964;' &#8592; elabExpInfer e'
    return $ ParE &#961;s e&#7473;' :* ISecT &#961;s &#964;'
  ReadE &#964; e' &#8594; do
    case &#964; of
      &#8469;T _ &#8594; skip
      &#8484;T _ &#8594; skip
      _ &#8594; throwCErrorCxt TypeCError &quot;elabExpInfer: ReadE: &#964; &#8713; {&#8469;T _,&#8484;T _}&quot; $ frhs
        [ (&quot;&#964;&quot;,pretty &#964;)
        ]
    e&#7473;' &#8592; elabExpCheck &#120138;T e'
    return $ ReadE &#964; e&#7473;' :* &#964;
  AppE e&#8321; e&#8322; &#8594; do
    e&#7473;&#8321; :* &#964;&#8321; &#8592; elabExpInfer e&#8321;
    case &#964;&#8321; of
      &#964;&#8321;&#8321; :&#8594;: (&#951; :* &#964;&#8321;&#8322;) &#8594; do
        e&#7473;&#8322; &#8592; elabExpCheck &#964;&#8321;&#8321; e&#8322;
        tellL cOutEffL &#951;
        return $ AppE e&#7473;&#8321; e&#7473;&#8322; :* &#964;&#8321;&#8322;
      _ &#8594; throwCErrorCxt TypeCError &quot;elabExpInfer: AppE: &#964;&#8321; &#8800; (_ :&#8594;: (_ :* _))&quot; $ frhs
        [ (&quot;&#964;&#8321;&quot;,pretty &#964;&#8321;)
        ]
  RevealE &#961;s&#8321; &#961;s&#8322; e' &#8594; do
    e&#7473;' :* &#964;' &#8592; elabExpInfer e'
    case &#964;' of
      ShareT _ _ &#964;'' &#8594; return $ RevealE &#961;s&#8321; &#961;s&#8322; e&#7473;' :* SSecT &#961;s&#8322; &#964;''
      _ &#8594; throwCErrorCxt TypeCError &quot;elabExpIner: RevealE: &#964;' &#8800; ShareT _ _ _&quot; $ frhs
        [ (&quot;&#964;'&quot;,pretty &#964;')
        ]
  TupE e&#8321; e&#8322; &#8594; do
    e&#7473;&#8321; :* &#964;&#8321; &#8592; elabExpInfer e&#8321;
    e&#7473;&#8322; :* &#964;&#8322; &#8592; elabExpInfer e&#8322;
    return $ TupE e&#7473;&#8321; e&#7473;&#8322; :* (&#964;&#8321; :&#215;: &#964;&#8322;)
  _ &#8594; throwCErrorCxt NotImplementedCError &quot;elabExpInfer&quot; null

-------------------
-- TYPE CHECKING --
-------------------

elabExpCheck &#8759; Type &#8594; Exp &#8594; CM Exp 
elabExpCheck &#964; e = siphon e ^$ localL cCxtSourceL (Some $ annotatedTag e) $ case extract e of
  LamE selfO &#968; e' &#8594; do
    case &#964; of
      &#964;&#8321; :&#8594;: (&#951; :* &#964;&#8322;) &#8594; 
        let f = case selfO of
              Some self &#8594; bindVar self &#964;
              None &#8594; id
        in f $ do
          &#951;' :* e&#7473; &#8592; undefined -- hijackL cOutEffL $ bindPat &#968; &#964;&#8321; $ elabExpCheck &#964;&#8322; e'
          -- when False {-(not $ &#951;' &#8849; &#951;)-} $ \ _ &#8594; 
          --   throwCErrorCxt TypeCError &quot;elabExpCheck: LamE: &#172; (&#951;' &#8849; &#951;)&quot; $ frhs
          --     [ (&quot;&#951;'&quot;,pretty &#951;')
          --     , (&quot;&#951;&quot;,pretty &#951;)
          --     ]
          return $ LamE selfO &#968; e&#7473;
      _ &#8594; throwCErrorCxt TypeCError &quot;elabExpCheck: LamE: &#964; &#8802; (_ &#8594; _)&quot; $ frhs
        [ (&quot;&#964;&quot;,pretty &#964;)
        ]
  LetTyE x &#964;' e' &#8594; do
    e&#7473;' &#8592; mapEnvL cCxtTmDecL ((x &#8614; &#964;') &#10828;) $ elabExpCheck &#964; e'
    return $ LetTyE x &#964;' e&#7473;'
  LetE &#968; e&#8321; e&#8322; &#8594; do
    &#964;'O :* f &#8592; case &#968; of
      VarP x &#8594; do
        x&#964;s &#8592; askL cCxtTmDecL
        return $ (x&#964;s &#8917;? x) :* mapEnvL cCxtTmDecL (delete x)
      _ &#8594; return $ None :* id
    e&#8321;&#7473; :* &#964;&#8321; &#8592; case &#964;'O of
      None &#8594; elabExpInfer e&#8321;
      Some &#964;&#8321; &#8594; do
        e&#8321;&#7473; &#8592; elabExpCheck &#964;&#8321; e&#8321;
        return $ e&#8321;&#7473; :* &#964;&#8321;
    e&#8322;&#7473; &#8592; f $ bindPat &#968; &#964;&#8321; $ elabExpCheck &#964; e&#8322;
    return $ LetE &#968; e&#8321;&#7473; e&#8322;&#7473;
  _ &#8594; do
    e&#7473; :* &#964;' &#8592; elabExpInfer e
    when (&#964;' &#8802; &#964;) $ \ _ &#8594;
      throwCErrorCxt TypeCError &quot;elabExpCheck: elabExpInfer: &#964;' &#8802; &#964;&quot; $ frhs
        [ (&quot;&#964;'&quot;,pretty &#964;')
        , (&quot;&#964;&quot;,pretty &#964;)
        ]
    return $ extract e&#7473;

-----------------------
-- TL TYPE INFERENCE --
-----------------------

elabTL &#8759; TL &#8594; CTLM ()
elabTL tl = case extract tl of
  PrinTL _&#961;nOs &#8594; do
    undefined
    -- old code
    -- let p&#961;s = pow &#961;nOs
    -- &#961;s' &#8592; getL ctlStatePrinsL
    -- when (pmap fst p&#961;s &#8745; pmap fst &#961;s' &#8802; p&#248;) $ \ _ &#8594; 
    --   throwCError (Some $ annotatedTag tl) TypeCError &quot;elabTL: PrinTL: p&#961;s &#8745; &#961;s' &#8802; &#8709;&quot; $ frhs
    --     [ (&quot;p&#961;s&quot;,pretty p&#961;s)
    --     , (&quot;&#961;s'&quot;,pretty &#961;s')
    --     ]
    -- putL ctlStatePrinsL $ p&#961;s &#8746; &#961;s'
  DeclTL x &#964; &#8594; do
    modifyL ctlStateTmDecL ((x &#8614; &#964;) &#10828;)
  DefnTL x &#968;s e &#8594; do
    let e' = buildLambda (annotatedTag tl) x &#968;s e
    x&#964;s &#8592; getL ctlStateTmDecL
    &#951; :* e'&#964;' &#8592; case x&#964;s &#8917;? x of
      Some &#964; &#8594; do
        modifyL ctlStateTmDecL (delete x)
        asCTLM $ do
          e&#7473;' &#8592; elabExpCheck &#964; e'
          return $ e&#7473;' :* &#964;
      None &#8594; asCTLM $ elabExpInfer e'
    when (&#951; &#8802; null) $ \ _ &#8594; 
      throwCError (Some $ annotatedTag tl) TypeCError &quot;elabTL: DefnTL: &#951; &#8800; null&quot; $ frhs
        [ (&quot;&#951;&quot;,pretty &#951;)
        ]
    modifyL ctlStateTmEnvL ((x &#8614; e'&#964;') &#10828;)
  _ &#8594; throwCError (Some $ annotatedTag tl) NotImplementedCError &quot;elabTL&quot; null

elabCTLs &#8759; &#119871; TL &#8594; CTLM ()
elabCTLs = eachWith elabTL

-------------
-- TESTING --
-------------

typecheckExample &#8759; &#120138; &#8594; IO (Exp &#8743; Type)
typecheckExample fn = do
  let path = &quot;examples/&quot; &#10746; fn &#10746; &quot;.psl&quot;
  out path
  s &#8592; read path
  let ts = tokens s
  ls &#8592; tokenizeIO lexer ts
  tls &#8592; parseIO cpTLs ls
  &#963;tl &#8592; evalCTLMIO &#963;tl&#8320; $ retState $ elabCTLs tls
  return $ ctlStateTmEnv &#963;tl &#8917;! var &quot;main&quot;

testTypecheckerExample &#8759; &#120138; &#8594; IO ()
testTypecheckerExample fn = pprint *$ snd ^$ typecheckExample fn

testTypechecker &#8759; IO ()
testTypechecker = do
  pprint $ ppHeader &quot;TESTING TYPE CHECKER&quot;
  testTypecheckerExample &quot;cmp&quot;
  testTypecheckerExample &quot;euclid&quot;

-}</span><span>
</span><a name="line-479"></a></pre></body></html>